//==-- OpenRISCISelDAGToDAG.cpp - A dag to dag inst selector for OpenRISC --==//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This file defines an instruction selector for the OpenRISC target.
//
//===----------------------------------------------------------------------===//

#include "OpenRISC.h"
#include "OpenRISCTargetMachine.h"
#include "llvm/DerivedTypes.h"
#include "llvm/Function.h"
#include "llvm/Intrinsics.h"
#include "llvm/CallingConv.h"
#include "llvm/Constants.h"
#include "llvm/CodeGen/MachineFrameInfo.h"
#include "llvm/CodeGen/MachineFunction.h"
#include "llvm/CodeGen/MachineInstrBuilder.h"
#include "llvm/CodeGen/MachineRegisterInfo.h"
#include "llvm/CodeGen/SelectionDAG.h"
#include "llvm/CodeGen/SelectionDAGISel.h"
#include "llvm/Target/TargetLowering.h"
#include "llvm/Support/Compiler.h"
#include "llvm/Support/Debug.h"
#include "llvm/Support/ErrorHandling.h"
#include "llvm/Support/raw_ostream.h"
using namespace llvm;

/// OpenRISCDAGToDAGISel - OpenRISC specific code to select OpenRISC machine
/// instructions for SelectionDAG operations.
///
namespace {
  class OpenRISCDAGToDAGISel : public SelectionDAGISel {
    const OpenRISCTargetLowering &Lowering;
    const OpenRISCSubtarget &Subtarget;

  public:
    OpenRISCDAGToDAGISel(OpenRISCTargetMachine &TM, CodeGenOpt::Level OptLevel)
      : SelectionDAGISel(TM, OptLevel),
        Lowering(*TM.getTargetLowering()),
        Subtarget(*TM.getSubtargetImpl()) { }

    virtual const char *getPassName() const {
      return "OpenRISC DAG->DAG Pattern Instruction Selection";
    }

    /// getI16Imm - Return a target constant with the specified value, of type
    /// i16.
    inline SDValue getI16Imm(uint64_t Imm) {
      return CurDAG->getTargetConstant(Imm, MVT::i16);
    }

    /// getI32Imm - Return a target constant with the specified value, of type
    /// i32.
    inline SDValue getI32Imm(uint64_t Imm) {
      return CurDAG->getTargetConstant(Imm, MVT::i32);
    }
    
    // Include the pieces autogenerated from the target description.
    #include "OpenRISCGenDAGISel.inc"

  private:
    SDNode *Select(SDNode *N);
  };
}  // end anonymous namespace

/// createOpenRISCISelDag - This pass converts a legalized DAG into a
/// OpenRISC-specific DAG, ready for instruction scheduling.
///
FunctionPass *llvm::createOpenRISCISelDag(OpenRISCTargetMachine &TM,
                                          CodeGenOpt::Level OptLevel) {
  return new OpenRISCDAGToDAGISel(TM, OptLevel);
}

SDNode *OpenRISCDAGToDAGISel::Select(SDNode *Node) {
  DebugLoc dl = Node->getDebugLoc();

  // Dump information about the Node being selected
  DEBUG(errs() << "Selecting: ");
  DEBUG(Node->dump(CurDAG));
  DEBUG(errs() << "\n");

  // If we have a custom node, we already have selected!
  if (Node->isMachineOpcode()) {
    DEBUG(errs() << "== ";
          Node->dump(CurDAG);
          errs() << "\n");
    return NULL;
  }

  // Select the default instruction
  SDNode *ResNode = SelectCode(Node);

  DEBUG(errs() << "=> ");
  if (ResNode == NULL || ResNode == Node)
    DEBUG(Node->dump(CurDAG));
  else
    DEBUG(ResNode->dump(CurDAG));
  DEBUG(errs() << "\n");

  return ResNode;
}
